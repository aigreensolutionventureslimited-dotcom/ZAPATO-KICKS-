<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapato Admin | Vault Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #050505;
            --surface: #0f0f0f;
            --accent: #c5a059; /* Gold */
            --text: #ffffff;
            --border: rgba(255,255,255,0.08);
            --gray: #666;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

        /* Navigation */
        nav { padding: 25px 6%; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #000; }
        .logo { font-family: 'Syne'; font-size: 0.9rem; letter-spacing: 4px; color: var(--accent); text-transform: uppercase; }

        .container { max-width: 1100px; margin: 0 auto; padding: 40px 6%; }

        /* Tabs */
        .tabs { display: flex; gap: 30px; margin-bottom: 40px; }
        .tab { padding-bottom: 10px; background: none; border: none; color: var(--gray); font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: 0.3s; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; margin-bottom: 30px; }
        h2 { font-family: 'Syne'; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 25px; text-transform: uppercase; color: var(--accent); }

        /* Form Inputs */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .field { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.55rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        input, select { background: #000; border: 1px solid #222; padding: 14px; color: #fff; font-size: 0.8rem; border-radius: 0; }
        
        .btn-gold { background: var(--accent); color: #000; border: none; padding: 16px 30px; font-weight: 800; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-gold:hover { opacity: 0.8; }
        .btn-gold:disabled { background: #222; color: #555; cursor: wait; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; font-size: 0.55rem; color: var(--gray); padding: 15px; border-bottom: 1px solid var(--border); text-transform: uppercase; }
        td { padding: 15px; font-size: 0.75rem; border-bottom: 1px solid var(--border); color: #ccc; }
        .p-img { width: 45px; height: 45px; object-fit: cover; background: #000; border: 1px solid #222; }

        /* Link Box */
        .link-box { background: #000; padding: 20px; border: 1px dashed var(--accent); color: var(--accent); font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .copy-btn { background: var(--accent); border: none; padding: 8px 15px; font-size: 0.6rem; font-weight: 800; cursor: pointer; }

        .status-badge { padding: 4px 8px; font-size: 0.5rem; font-weight: 800; text-transform: uppercase; background: rgba(197, 160, 89, 0.1); color: var(--accent); }
    </style>
</head>
<body>

<nav>
    <div class="logo">VAULT CONTROL</div>
    <div style="font-size: 0.5rem; color: var(--gray); font-weight: 700;">SYSTEM v2.0</div>
</nav>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showSec('inv', this)">Inventory</button>
        <button class="tab" onclick="showSec('aff', this)">Affiliates</button>
        <button class="tab" onclick="showSec('sales', this)">Sales Logs</button>
    </div>

    <section id="sec-inv">
        <div class="card">
            <h2>Add New Luxury Style</h2>
            <div class="grid">
                <div class="field"><label>Product Name</label><input type="text" id="p-name" placeholder="Nike Jordan 1 Retro"></div>
                <div class="field"><label>Category</label>
                    <select id="p-cat">
                        <option>Sneakers</option><option>Corporate</option><option>Palms</option><option>Slides</option>
                    </select>
                </div>
                <div class="field"><label>Price (₦)</label><input type="number" id="p-price" placeholder="125000"></div>
            </div>
            <div class="field" style="margin-bottom: 25px;">
                <label>Gallery (Select Multiple Images)</label>
                <input type="file" id="p-files" multiple accept="image/*" style="border: 1px dashed #333; padding: 20px;">
            </div>
            <button class="btn-gold" id="upBtn" onclick="uploadProduct()">Sync to Storefront</button>
        </div>

        <div class="card">
            <h2>Last Inventory Styles</h2>
            <table>
                <thead><tr><th>Preview</th><th>Name</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="inv-body"></tbody>
            </table>
        </div>
    </section>

    <section id="sec-aff" style="display:none">
        <div class="card">
            <h2>Onboard New Partner</h2>
            <div class="grid">
                <div class="field"><label>Partner Name</label><input type="text" id="af-name" placeholder="Chidi Okafor"></div>
                <div class="field"><label>Unique Code</label><input type="text" id="af-code" placeholder="CHIDI10"></div>
            </div>
            <button class="btn-gold" id="afBtn" onclick="addAffiliate()">Generate Vault Link</button>
            <div id="link-display"></div>
        </div>

        <div class="card">
            <h2>Active Partners</h2>
            <table>
                <thead><tr><th>Name</th><th>Code</th><th>Link</th><th>Action</th></tr></thead>
                <tbody id="af-body"></tbody>
            </table>
        </div>
    </section>

    <section id="sec-sales" style="display:none">
        <div class="card">
            <h2>Recent Orders</h2>
            <table>
                <thead><tr><th>Date</th><th>Amount</th><th>Affiliate</th><th>Status</th></tr></thead>
                <tbody id="sales-body"></tbody>
            </table>
        </div>
    </section>
</div>

<script>
const SB_URL = 'https://rvfuenrggxverrnnmcet.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2ZnVlbnJnZ3h2ZXJybm5tY2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4Njc2MTcsImV4cCI6MjA4MzQ0MzYxN30.aKCaWeXR1Le68waDqG_UHiOOZpkZYNC2FTTMutY-CqI';
const supa = supabase.createClient(SB_URL, SB_KEY);

function showSec(id, btn) {
    ['inv', 'aff', 'sales'].forEach(s => document.getElementById('sec-'+s).style.display = 'none');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('sec-'+id).style.display = 'block';
    btn.classList.add('active');
    if(id === 'inv') loadInv();
    if(id === 'aff') loadAff();
    if(id === 'sales') loadSales();
}

// INVENTORY LOGIC
async function uploadProduct() {
    const btn = document.getElementById('upBtn');
    const files = document.getElementById('p-files').files;
    const name = document.getElementById('p-name').value;
    const price = document.getElementById('p-price').value;
    const cat = document.getElementById('p-cat').value;

    if(!name || !price || files.length === 0) return alert("All fields are mandatory.");
    btn.disabled = true; btn.innerText = "UPLOADING TO VAULT...";

    try {
        let urls = [];
        for (let file of files) {
            const fName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            await supa.storage.from('product-images').upload(fName, file);
            const { data: pUrl } = supa.storage.from('product-images').getPublicUrl(fName);
            urls.push(pUrl.publicUrl);
        }
        await supa.from('products').insert([{ name, price, cat, image_url: urls.join(',') }]);
        alert("Product synced successfully.");
        location.reload();
    } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Sync to Storefront"; }
}

async function loadInv() {
    const { data } = await supa.from('products').select('*').order('created_at', { ascending: false });
    document.getElementById('inv-body').innerHTML = data.map(p => `
        <tr>
            <td><img src="${p.image_url.split(',')[0]}" class="p-img"></td>
            <td><strong>${p.name}</strong><br><small>${p.cat}</small></td>
            <td>₦${Number(p.price).toLocaleString()}</td>
            <td><button onclick="delP(${p.id})" style="color:red; background:none; border:none; cursor:pointer; font-size:0.6rem; font-weight:700;">REMOVE</button></td>
        </tr>
    `).join('');
}

async function delP(id) {
    if(confirm("Permanently delete this style?")) {
        await supa.from('products').delete().eq('id', id);
        loadInv();
    }
}

// AFFILIATE LOGIC
async function addAffiliate() {
    const name = document.getElementById('af-name').value;
    const code = document.getElementById('af-code').value.trim().toUpperCase();
    if(!name || !code) return alert("Provide partner name and code.");

    const { error } = await supa.from('affiliates').insert([{ name, code }]);
    if(error) return alert("This code is already active.");

    const link = `${window.location.origin}/index.html?ref=${code}`;
    document.getElementById('link-display').innerHTML = `
        <div class="link-box">
            <span style="word-break:break-all;">${link}</span>
            <button class="copy-btn" onclick="navigator.clipboard.writeText('${link}'); alert('Copied!')">COPY LINK</button>
        </div>
    `;
    loadAff();
}

async function loadAff() {
    const { data } = await supa.from('affiliates').select('*').order('created_at', { ascending: false });
    document.getElementById('af-body').innerHTML = data.map(a => `
        <tr>
            <td><strong>${a.name}</strong></td>
            <td style="color:var(--accent)">${a.code}</td>
            <td><small>${window.location.origin}/index.html?ref=${a.code}</small></td>
            <td><button onclick="delA(${a.id})" style="color:#ff4d4d; background:none; border:none; cursor:pointer; font-size:0.6rem;">DELETE</button></td>
        </tr>
    `).join('');
}

async function delA(id) {
    if(confirm("Deactivate this partner?")) {
        await supa.from('affiliates').delete().eq('id', id);
        loadAff();
    }
}

// SALES LOGIC
async function loadSales() {
    const { data } = await supa.from('sales').select('*').order('created_at', { ascending: false });
    document.getElementById('sales-body').innerHTML = data.map(s => `
        <tr>
            <td style="color:#666">${new Date(s.created_at).toLocaleDateString()}</td>
            <td>₦${Number(s.amount).toLocaleString()}</td>
            <td><strong style="color:var(--accent)">${s.affiliate_code}</strong></td>
            <td><span class="status-badge">Confirmed</span></td>
        </tr>
    `).join('');
}

// Init
loadInv();
</script>
</body>
</html>